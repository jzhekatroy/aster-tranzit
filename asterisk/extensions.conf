; Asterisk Dialplan для Phone Proxy System
; Этот файл должен быть помещен в /etc/asterisk/extensions.conf
; или включен через #include в основной extensions.conf

[globals]
; API endpoint для получения реального номера
API_ENDPOINT=http://localhost:5000/lookup/real

[incoming]
; Контекст для входящих звонков на фейковые номера
exten => _X.,1,NoOp(Incoming call to fake number: ${EXTEN})
    ; Логирование входящего звонка
    same => n,Verbose(1,Processing call for fake number: ${EXTEN})
    
    ; Получаем реальный номер из API
    same => n,Set(REAL_PHONE=${CURL(${API_ENDPOINT}/${EXTEN})})
    same => n,Verbose(1,API Response: ${REAL_PHONE})
    
    ; Парсим JSON ответ (извлекаем real_phone из {"success":true,"real_phone":"123456"})
    ; Простой вариант: используем SHELL для парсинга через jq
    ; same => n,Set(REAL_PHONE_PARSED=${SHELL(echo '${REAL_PHONE}' | jq -r '.real_phone')})
    
    ; Альтернатива: используем CUT для простого парсинга (предполагаем что API возвращает только номер)
    ; Или настраиваем API чтобы возвращать просто номер для Asterisk
    
    ; Проверяем что номер получен
    same => n,GotoIf($["${REAL_PHONE}" = ""]?error)
    same => n,GotoIf($[${LEN(${REAL_PHONE})} < 10]?error)
    
    ; Делаем исходящий звонок на реальный номер
    same => n,Verbose(1,Dialing real number: ${REAL_PHONE})
    same => n,Dial(SIP/${REAL_PHONE}@outbound-trunk,60,tT)
    
    ; Обработка статусов
    same => n,GotoIf($["${DIALSTATUS}" = "ANSWER"]?answered)
    same => n,GotoIf($["${DIALSTATUS}" = "BUSY"]?busy)
    same => n,GotoIf($["${DIALSTATUS}" = "NOANSWER"]?noanswer)
    same => n,Goto(failed)

    ; Успешный ответ
    same => n(answered),NoOp(Call answered)
    same => n,Hangup()

    ; Занято
    same => n(busy),NoOp(Number is busy)
    same => n,Busy(20)
    same => n,Hangup()

    ; Нет ответа
    same => n(noanswer),NoOp(No answer)
    same => n,Hangup()

    ; Ошибка дозвона
    same => n(failed),NoOp(Call failed: ${DIALSTATUS})
    same => n,Playback(number-not-answering)
    same => n,Hangup()

    ; Ошибка получения номера из API
    same => n(error),NoOp(Error: Could not retrieve real phone number)
    same => n,Verbose(1,API returned: ${REAL_PHONE})
    same => n,Playback(invalid)
    same => n,Hangup()


[incoming-simple]
; Упрощенная версия с прямым запросом к MySQL
; Требует настройки res_odbc и func_odbc

exten => _X.,1,NoOp(Incoming call to fake number: ${EXTEN})
    same => n,Verbose(1,Looking up real phone for: ${EXTEN})
    
    ; Прямой запрос к БД через ODBC
    same => n,Set(REAL_PHONE=${ODBC_PHONE_LOOKUP(${EXTEN})})
    same => n,Verbose(1,Real phone from DB: ${REAL_PHONE})
    
    ; Проверка
    same => n,GotoIf($["${REAL_PHONE}" = ""]?notfound)
    
    ; Звоним на реальный номер
    same => n,Dial(SIP/${REAL_PHONE}@outbound-trunk,60,tT)
    same => n,Hangup()
    
    ; Номер не найден
    same => n(notfound),NoOp(Fake number not found in database)
    same => n,Playback(invalid)
    same => n,Hangup()


[outbound]
; Контекст для исходящих звонков (можно добавить дополнительную логику)
exten => _X.,1,NoOp(Outbound call to: ${EXTEN})
    same => n,Dial(SIP/${EXTEN}@outbound-trunk,60)
    same => n,Hangup()

